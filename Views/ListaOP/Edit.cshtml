@model AiDbMaster.Models.ListaOP

@{
    ViewData["Title"] = $"Modifica Ordine {Model.IdentificativoCompleto}";
}

<div class="container">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-md-8">
            <h2><i class="bi bi-pencil text-primary"></i> @ViewData["Title"]</h2>
            <p class="text-muted">Modifica i dettagli dell'ordine di produzione</p>
        </div>
        <div class="col-md-4 text-end">
            <a asp-action="Details" asp-route-id="@Model.IdListaOP" class="btn btn-info me-2">
                <i class="bi bi-eye"></i> Dettagli
            </a>
            <a asp-action="Index" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> Torna alla Lista
            </a>
        </div>
    </div>

    <form asp-action="Edit" method="post">
        <div asp-validation-summary="ModelOnly" class="alert alert-danger"></div>
        <input type="hidden" asp-for="IdListaOP" />
        
        <div class="row">
            <!-- Colonna sinistra -->
            <div class="col-md-6">
                <!-- Identificazione ordine -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5><i class="bi bi-tag"></i> Identificazione Ordine</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <div class="form-group mb-3">
                                    <label asp-for="TipoOrdine" class="form-label">Tipo</label>
                                    <select asp-for="TipoOrdine" class="form-select">
                                        <option value="P">P - Produzione</option>
                                        <option value="M">M - Manutenzione</option>
                                        <option value="T">T - Test</option>
                                    </select>
                                    <span asp-validation-for="TipoOrdine" class="text-danger"></span>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group mb-3">
                                    <label asp-for="AnnoOrdine" class="form-label">Anno</label>
                                    <input asp-for="AnnoOrdine" class="form-control" type="number" min="2020" max="2030" />
                                    <span asp-validation-for="AnnoOrdine" class="text-danger"></span>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group mb-3">
                                    <label asp-for="SerieOrdine" class="form-label">Serie</label>
                                    <input asp-for="SerieOrdine" class="form-control" maxlength="3" />
                                    <span asp-validation-for="SerieOrdine" class="text-danger"></span>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group mb-3">
                                    <label asp-for="NumeroOrdine" class="form-label">Numero</label>
                                    <input asp-for="NumeroOrdine" class="form-control" type="number" min="1" />
                                    <span asp-validation-for="NumeroOrdine" class="text-danger"></span>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label asp-for="RigaOrdine" class="form-label">Riga</label>
                                    <input asp-for="RigaOrdine" class="form-control" type="number" min="1" />
                                    <span asp-validation-for="RigaOrdine" class="text-danger"></span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label asp-for="Priorita" class="form-label">Priorità</label>
                                    <select asp-for="Priorita" asp-items="ViewBag.Priorita" class="form-select"></select>
                                    <span asp-validation-for="Priorita" class="text-danger"></span>
                                </div>
                            </div>
                        </div>
                        <div class="form-group mb-3">
                            <label asp-for="DescrOrdine" class="form-label">Descrizione Ordine</label>
                            <input asp-for="DescrOrdine" class="form-control" maxlength="100" />
                            <span asp-validation-for="DescrOrdine" class="text-danger"></span>
                        </div>
                    </div>
                </div>

                <!-- Articolo -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5><i class="bi bi-box"></i> Articolo da Produrre</h5>
                    </div>
                    <div class="card-body">
                        <div class="form-group mb-3">
                            <label asp-for="CodiceArticolo" class="form-label">Codice Articolo *</label>
                            <input asp-for="CodiceArticolo" class="form-control" maxlength="50" />
                            <span asp-validation-for="CodiceArticolo" class="text-danger"></span>
                        </div>
                        <div class="form-group mb-3">
                            <label asp-for="DescrizioneArticolo" class="form-label">Descrizione *</label>
                            <input asp-for="DescrizioneArticolo" class="form-control" maxlength="50" />
                            <span asp-validation-for="DescrizioneArticolo" class="text-danger"></span>
                        </div>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-group mb-3">
                                    <label asp-for="UnitaMisura" class="form-label">U.M. *</label>
                                    <select asp-for="UnitaMisura" class="form-select">
                                        <option value="PZ">PZ - Pezzi</option>
                                        <option value="KG">KG - Chilogrammi</option>
                                        <option value="MT">MT - Metri</option>
                                        <option value="LT">LT - Litri</option>
                                        <option value="MQ">MQ - Metri Quadri</option>
                                    </select>
                                    <span asp-validation-for="UnitaMisura" class="text-danger"></span>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group mb-3">
                                    <label asp-for="Quantita" class="form-label">Quantità *</label>
                                    <input asp-for="Quantita" class="form-control" type="number" step="0.001" min="0.001" />
                                    <span asp-validation-for="Quantita" class="text-danger"></span>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group mb-3">
                                    <label asp-for="QuantitaProdotta" class="form-label">Quantità Prodotta</label>
                                    <input asp-for="QuantitaProdotta" class="form-control" type="number" step="0.001" min="0" />
                                    <span asp-validation-for="QuantitaProdotta" class="text-danger"></span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Progresso -->
                        @if (Model.Quantita > 0)
                        {
                            <div class="form-group mb-3">
                                <label class="form-label">Progresso Produzione</label>
                                <div class="progress" style="height: 25px;">
                                    <div class="progress-bar" role="progressbar" style="width: @Model.PercentualeCompletamento%">
                                        @Model.PercentualeCompletamento.ToString("N1")%
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>

            <!-- Colonna destra -->
            <div class="col-md-6">
                <!-- Assegnazioni -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5><i class="bi bi-people"></i> Assegnazioni</h5>
                    </div>
                    <div class="card-body">
                        <div class="form-group mb-3">
                            <label asp-for="IdStato" class="form-label">Stato *</label>
                            <select asp-for="IdStato" asp-items="ViewBag.IdStato" class="form-select"></select>
                            <span asp-validation-for="IdStato" class="text-danger"></span>
                        </div>
                        <div class="form-group mb-3">
                            <label asp-for="IdCentroLavoro" class="form-label">Centro di Lavoro *</label>
                            <select asp-for="IdCentroLavoro" asp-items="ViewBag.IdCentroLavoro" class="form-select">
                                <option value="">-- Seleziona Centro --</option>
                            </select>
                            <span asp-validation-for="IdCentroLavoro" class="text-danger"></span>
                        </div>
                        <div class="form-group mb-3">
                            <label asp-for="IdLavorazione" class="form-label">Lavorazione</label>
                            <select asp-for="IdLavorazione" asp-items="ViewBag.IdLavorazione" class="form-select">
                                <option value="">-- Seleziona Lavorazione --</option>
                            </select>
                            <span asp-validation-for="IdLavorazione" class="text-danger"></span>
                        </div>
                        <div class="form-group mb-3">
                            <label asp-for="IdOperatore" class="form-label">Operatore</label>
                            <select asp-for="IdOperatore" asp-items="ViewBag.IdOperatore" class="form-select">
                                <option value="">-- Seleziona Operatore --</option>
                            </select>
                            <span asp-validation-for="IdOperatore" class="text-danger"></span>
                        </div>
                        <div class="form-group mb-3">
                            <label asp-for="CostoOrario" class="form-label">Costo Orario (€)</label>
                            <input asp-for="CostoOrario" class="form-control" type="number" step="0.01" min="0" />
                            <span asp-validation-for="CostoOrario" class="text-danger"></span>
                        </div>
                    </div>
                </div>

                <!-- Pianificazione -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5><i class="bi bi-calendar"></i> Pianificazione</h5>
                    </div>
                    <div class="card-body">
                        <div class="form-group mb-3">
                            <label asp-for="DataInizioOP" class="form-label">Data Inizio OP *</label>
                            <input asp-for="DataInizioOP" class="form-control" type="datetime-local" />
                            <span asp-validation-for="DataInizioOP" class="text-danger"></span>
                        </div>
                        <div class="form-group mb-3">
                            <label asp-for="DataFinePrevista" class="form-label">Data Fine Prevista</label>
                            <input asp-for="DataFinePrevista" class="form-control" type="datetime-local" />
                            <span asp-validation-for="DataFinePrevista" class="text-danger"></span>
                        </div>
                        <div class="form-group mb-3">
                            <label asp-for="DataFineOP" class="form-label">Data Fine Effettiva</label>
                            <input asp-for="DataFineOP" class="form-control" type="datetime-local" />
                            <span asp-validation-for="DataFineOP" class="text-danger"></span>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label asp-for="TempoCiclo" class="form-label">Tempo Ciclo (sec) *</label>
                                    <input asp-for="TempoCiclo" class="form-control" type="number" min="1" />
                                    <span asp-validation-for="TempoCiclo" class="text-danger"></span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label asp-for="TempoSetup" class="form-label">Tempo Setup (min)</label>
                                    <input asp-for="TempoSetup" class="form-control" type="number" min="0" />
                                    <span asp-validation-for="TempoSetup" class="text-danger"></span>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label asp-for="DataInizioSetup" class="form-label">Data Inizio Setup</label>
                                    <input asp-for="DataInizioSetup" class="form-control" type="datetime-local" />
                                    <span asp-validation-for="DataInizioSetup" class="text-danger"></span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label asp-for="TempoEffettivo" class="form-label">Tempo Effettivo (sec)</label>
                                    <input asp-for="TempoEffettivo" class="form-control" type="number" min="0" />
                                    <span asp-validation-for="TempoEffettivo" class="text-danger"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Note -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5><i class="bi bi-sticky"></i> Note</h5>
                    </div>
                    <div class="card-body">
                        <div class="form-group mb-3">
                            <label asp-for="Note" class="form-label">Note</label>
                            <textarea asp-for="Note" class="form-control" rows="4" maxlength="400"></textarea>
                            <span asp-validation-for="Note" class="text-danger"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Pulsanti -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-body text-center">
                        <button type="submit" class="btn btn-primary btn-lg me-3">
                            <i class="bi bi-check-circle"></i> Salva Modifiche
                        </button>
                        <a asp-action="Details" asp-route-id="@Model.IdListaOP" class="btn btn-info btn-lg me-3">
                            <i class="bi bi-eye"></i> Visualizza Dettagli
                        </a>
                        <a asp-action="Index" class="btn btn-outline-secondary btn-lg">
                            <i class="bi bi-x-circle"></i> Annulla
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    
    <script>
        $(document).ready(function() {
            // Aggiorna progresso quando cambia quantità prodotta
            $('#QuantitaProdotta').on('input', function() {
                aggiornaProgresso();
            });
            
            // Auto-completamento quando stato diventa "Chiuso"
            $('#IdStato').on('change', function() {
                if ($(this).val() == '3' && !$('#DataFineOP').val()) { // 3 = Chiuso
                    var now = new Date();
                    $('#DataFineOP').val(now.toISOString().slice(0, 16));
                }
            });
        });
        
        function aggiornaProgresso() {
            var quantita = parseFloat($('#Quantita').val()) || 0;
            var quantitaProdotta = parseFloat($('#QuantitaProdotta').val()) || 0;
            
            if (quantita > 0) {
                var percentuale = Math.min((quantitaProdotta / quantita) * 100, 100);
                $('.progress-bar').css('width', percentuale + '%').text(percentuale.toFixed(1) + '%');
                
                // Auto-completamento se raggiunge il 100%
                if (percentuale >= 100 && $('#IdStato').val() != '3') {
                    if (confirm('La produzione è completata al 100%. Vuoi impostare lo stato su "Chiuso"?')) {
                        $('#IdStato').val('3');
                        if (!$('#DataFineOP').val()) {
                            var now = new Date();
                            $('#DataFineOP').val(now.toISOString().slice(0, 16));
                        }
                    }
                }
            }
        }
    </script>
}
